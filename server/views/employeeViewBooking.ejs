<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title><%=title%></title>
  <!-- Bootstrap CSS -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
  <!-- Font Awesome -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <!-- Google Fonts -->
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <!-- css custom -->
  <link rel="stylesheet" href="/css/managerDashboard.css">
</head>

<body>
  <div class="dashboard-container">
    <!-- Sidebar -->
    <%-include('./layouts/employeeSidebar')%>

      <!-- Main Content -->
      <div class="main-content">
        <!-- Header -->
        <div class="header">
          <div class="page-title">
            <h1>Bookings Overview</h1>
            <p>Welcome back! Here all the bookings are listed.</p>
          </div>
          <div class="header-actions">

          </div>
        </div>
        <!-- Content Area -->
        <div class="content-area">
          <!-- Projects Table -->
          <div class="content-card">
            <div class="card-header">
              <h3>Bookings <span>(<%=bookingsCount %>)</span></h3>
            </div>
            <div class="table-responsive">
              <table class="table table-sm">
                <thead>
                  <tr>
                    <th>S.No</th>
                    <th>Customer Name</th>
                    <th>Email</th>
                    <th>Phone</th>
                    <th>Preferred Date</th>
                    <th>Status</th>
                    <th>Assigned To</th>
                    <th>Assigned By</th>
                    <th>Details</th>
                  </tr>
                </thead>
                <tbody>
                  <% if (booking.length> 0) { %>
                    <% booking.forEach((item, index)=> { %>
                      <% const assignedTechnician=users.find(technician=> technician.id.toString() == item.assignedTo);
                        %>
                        <% if (assignedTechnician && assignedTechnician.id.toString()===employee.id.toString()) { %>
                          <tr>
                            <td>
                              <%= index + 1 %>
                            </td>
                            <td>
                              <%= item.name %>
                            </td>
                            <td>
                              <%= item.email %>
                            </td>
                            <td>
                              <%= item.phone %>
                            </td>
                            <td>
                              <%= new Date(item.preferredDate).toLocaleDateString() %>
                            </td>
                            <td>
                              <%= item.status %>
                            </td>
                            <td>
                              <%= assignedTechnician ? assignedTechnician.name : '' %>
                            </td>
                            <td>
                              <% const assignedByTechnician=users.find(technician=> technician.id.toString() ==
                                item.assignedBy); %>
                                <%= assignedByTechnician ? assignedByTechnician.name : '' %>
                            </td>
                            <td>
                              <button type="button" class="btn btn-info Details" data-toggle="modal"
                                data-target="#customerModal<%= index %>">
                                Customer Details
                              </button>
                            </td>
                          </tr>
                          <% } %>
                            <% }) %>
                              <% } else { %>
                                <tr>
                                  <td colspan="12" class="text-center py-4">
                                    <div class="d-flex flex-column align-items-center">
                                      <h4 class="text-muted">No bookings found</h4>
                                    </div>
                                  </td>
                                </tr>
                                <% } %>
                </tbody>
              </table>
            </div>
          </div>

          <!-- MODALS OUTSIDE THE TABLE -->
          <% if (booking.length> 0) { %>
            <% booking.forEach((item, index)=> { %>
              <% const assignedTechnician=users.find(technician=> technician.id.toString() == item.assignedTo); %>
                <% if (assignedTechnician && assignedTechnician.id.toString()===employee.id.toString()) { %>
                  <div class="modal fade" id="customerModal<%= index %>" tabindex="-1" role="dialog"
                    aria-labelledby="customerModalLabel<%= index %>" aria-hidden="true">
                    <div class="modal-dialog modal-dialog-centered modal-lg" role="document">
                      <div class="modal-content">
                        <!-- Modern Header with Gradient -->
                        <div class="modal-header bg-gradient-primary text-white border-0 position-relative">
                          <div class="d-flex align-items-center w-100">
                            <div
                              class="avatar-circle bg-white text-primary rounded-circle d-flex align-items-center justify-content-center mr-3"
                              style="width: 45px; height: 45px;">
                              <i class="fas fa-user-tie"></i>
                            </div>
                            <div class="flex-grow-1">
                              <h5 class="modal-title mb-0">Service Request Details</h5>
                              <small class="opacity-8">Booking ID: #<%= item._id.toString().slice(-8).toUpperCase() %>
                              </small>
                            </div>
                            <button type="button" class="close text-white opacity-8 position-absolute"
                              style="right: 1.5rem; top: 1.5rem;" data-dismiss="modal" aria-label="Close">
                              <span aria-hidden="true">&times;</span>
                            </button>
                          </div>
                        </div>

                        <!-- Modern Body -->
                        <div class="modal-body p-0">
                          <!-- Customer Profile Section -->
                          <div class="profile-section bg-gradient-light px-4 py-4 border-bottom">
                            <div class="row align-items-center">
                              <div class="col-auto">
                                <div
                                  class="customer-avatar bg-primary text-white rounded-circle d-flex align-items-center justify-content-center shadow"
                                  style="width: 70px; height: 70px; font-size: 1.8rem;">
                                  <i class="fas fa-user"></i>
                                </div>
                              </div>
                                <% if(success && success.length> 0){ %>
                    <div class="alert alert-success" role="alert">
                        <%= success %>
                    </div>
                    <% } %>
                        <% if(error && error.length> 0){ %>
                            <div class="alert alert-danger" role="alert">
                                <%= error %>
                            </div>
                            <% } %>
                              <div class="col">
                                <h4 class="mb-2 text-dark font-weight-bold">
                                  <%= item.name %>
                                </h4>
                                <div class="d-flex flex-wrap gap-2 align-items-center">
                                  <span
                                    class="status-badge badge text-dark <% if (item.status === 'Completed') { %>badge-success<% } %> <% if (item.status === 'Pending') { %>badge-warning<% } %> <% if (item.status === 'In Progress') { %>badge-info<% } %> <% if (item.status === 'Cancelled') { %>badge-danger<% } %> <% if (item.status === 'Confirmed') { %>badge-primary<% } %> badge-pill px-3 py-2 shadow-sm">
                                    <i
                                      class="fas <% if (item.status === 'Completed') { %>fa-check-circle<% } %> <% if (item.status === 'Pending') { %>fa-clock<% } %> <% if (item.status === 'In Progress') { %>fa-spinner fa-spin<% } %> <% if (item.status === 'Cancelled') { %>fa-times-circle<% } %> <% if (item.status === 'Confirmed') { %>fa-calendar-check<% } %> mr-2"></i>
                                    <%= item.status %>
                                  </span>
                                  <span class="badge badge-light text-dark badge-pill px-3 py-2 border shadow-sm">
                                    <i class="fas fa-calendar-alt mr-2 text-warning"></i>
                                    <%= new Date(item.preferredDate).toLocaleDateString() %>
                                  </span>
                                </div>
                              </div>
                            </div>
                          </div>

                          <!-- Information Cards Grid -->
                          <div class="container-fluid py-4">
                            <div class="row g-4">

                              <!-- Contact Information Card -->
                              <div class="col-lg-6">
                                <div class="info-card card border-0 shadow-sm h-100">
                                  <div class="card-header bg-transparent border-0 pb-2">
                                    <h6 class="mb-0 text-primary font-weight-bold">
                                      <i class="fas fa-address-card mr-2"></i>Contact Information
                                    </h6>
                                  </div>
                                  <div class="card-body">
                                    <div class="space-y-3">
                                      <div class="d-flex align-items-center p-3 bg-light rounded-lg border">
                                        <div
                                          class="icon-circle bg-primary text-white rounded-circle d-flex align-items-center justify-content-center mr-3 shadow"
                                          style="width: 42px; height: 42px;">
                                          <i class="fas fa-user"></i>
                                        </div>
                                        <div class="flex-grow-1">
                                          <small class="text-muted d-block mb-1">Customer Name</small>
                                          <span class="text-dark font-weight-bold">
                                            <%= item.name %>
                                          </span>
                                        </div>
                                      </div>

                                      <div class="d-flex align-items-center p-3 bg-light rounded-lg border">
                                        <div
                                          class="icon-circle bg-info text-white rounded-circle d-flex align-items-center justify-content-center mr-3 shadow"
                                          style="width: 42px; height: 42px;">
                                          <i class="fas fa-envelope"></i>
                                        </div>
                                        <div class="flex-grow-1">
                                          <small class="text-muted d-block mb-1">Email Address</small>
                                          <a href="mailto:<%= item.email %>"
                                            class="text-dark font-weight-bold text-decoration-none">
                                            <%= item.email %>
                                          </a>
                                        </div>
                                      </div>

                                      <div class="d-flex align-items-center p-3 bg-light rounded-lg border">
                                        <div
                                          class="icon-circle bg-success text-white rounded-circle d-flex align-items-center justify-content-center mr-3 shadow"
                                          style="width: 42px; height: 42px;">
                                          <i class="fas fa-phone"></i>
                                        </div>
                                        <div class="flex-grow-1">
                                          <small class="text-muted d-block mb-1">Phone Number</small>
                                          <a href="tel:<%= item.phone %>"
                                            class="text-dark font-weight-bold text-decoration-none">
                                            <%= item.phone %>
                                          </a>
                                        </div>
                                      </div>
                                    </div>
                                  </div>
                                </div>
                              </div>

                              <!-- Address Information Card -->
                              <div class="col-lg-6">
                                <div class="info-card card border-0 shadow-sm h-100">
                                  <div class="card-header bg-transparent border-0 pb-2">
                                    <h6 class="mb-0 text-purple font-weight-bold">
                                      <i class="fas fa-map-marker-alt mr-2"></i>Service Address
                                    </h6>
                                  </div>
                                  <div class="card-body">
                                    <div class="d-flex align-items-start p-3 bg-light rounded-lg border h-100">
                                      <div
                                        class="icon-circle bg-blue text-white rounded-circle d-flex align-items-center justify-content-center mr-3 shadow mt-1"
                                        style="width: 42px; height: 42px;">
                                        <i class="fas fa-home"></i>
                                      </div>
                                      <div class="flex-grow-1">
                                        <small class="text-muted d-block mb-1">Full Address</small>
                                        <span class="text-dark font-weight-bold">
                                          <% if (item.address ) { %>
                                            <%= item.address %><br>

                                              <% } else { %>
                                                <span class="text-muted">No address
                                                  provided</span>
                                                <% } %>
                                        </span>

                                      </div>
                                    </div>
                                  </div>
                                </div>
                              </div>

                              <!-- Service Details Card -->
                              <div class="col-md-6">
                                <div class="info-card card border-0 shadow-sm h-100">
                                  <div class="card-header bg-transparent border-0 pb-2">
                                    <h6 class="mb-0 text-info font-weight-bold">
                                      <i class="fas fa-tools mr-2"></i>Appliance Details
                                    </h6>
                                  </div>
                                  <div class="card-body">
                                    <div class="service-item p-4 bg-info-light rounded-lg border text-center h-100">
                                      <i class="fas fa-tv fa-3x text-info mb-3"></i>
                                      <h5 class="text-dark mb-2 font-weight-bold">
                                        <%= item.applianceType %>
                                      </h5>
                                      <small class="text-muted">Appliance Type</small>
                                      <% if (item.applianceBrand) { %>
                                        <div class="mt-2 pt-2 border-top">
                                          <small class="text-muted">Brand:</small>
                                          <div class="font-weight-bold text-dark">
                                            <%= item.applianceBrand %>
                                          </div>
                                        </div>
                                        <% } %>
                                          <% if (item.applianceModel) { %>
                                            <div class="mt-1">
                                              <small class="text-muted">Model:</small>
                                              <div class="font-weight-bold text-dark">
                                                <%= item.applianceModel %>
                                              </div>
                                            </div>
                                            <% } %>
                                    </div>
                                  </div>
                                </div>
                              </div>

                              <!-- Service Type & Status Card -->
                              <div class="col-md-6">
                                <div class="info-card card border-0 shadow-sm h-100">
                                  <div class="card-header bg-transparent border-0 pb-2">
                                    <h6 class="mb-0 text-warning font-weight-bold">
                                      <i class="fas fa-concierge-bell mr-2"></i>Service & Status
                                    </h6>
                                  </div>
                                  <div class="card-body">
                                    <div class="service-item p-4 bg-warning-light rounded-lg border text-center mb-3">
                                      <i class="fas fa-wrench fa-3x text-warning mb-3"></i>
                                      <h5 class="text-dark mb-2 font-weight-bold">
                                        <%= item.serviceType %>
                                      </h5>
                                      <small class="text-muted">Service Type</small>
                                    </div>

                                    <!-- Status Update Section -->
<div class="status-update-section mt-3">
  <label class="form-label text-muted small font-weight-bold">UPDATE STATUS:</label>
  <form action="/employee/update-booking-status" method="post">
    <input type="hidden" name="bookingId" value="<%= item._id %>">
    <div class="btn-group w-100 shadow-sm" role="group">
      <button type="submit" name="status" value="Pending" class="btn btn-outline-warning btn-sm status-btn <%= item.status === 'Pending' ? 'active' : '' %>">
        <i class="fas fa-clock mr-1"></i>Pending
      </button>
      <button type="submit" name="status" value="In Progress" class="btn btn-outline-info btn-sm status-btn <%= item.status === 'In Progress' ? 'active' : '' %>">
        <i class="fas fa-spinner mr-1"></i>In Progress
      </button>
      <button type="submit" name="status" value="Completed" class="btn btn-outline-success btn-sm status-btn <%= item.status === 'Completed' ? 'active' : '' %>">
        <i class="fas fa-check mr-1"></i>Complete
      </button>
    </div>
  </form>
</div>
                                    
                                  </div>
                                </div>
                              </div>

                              <!-- Schedule & Technician Card -->
                              <div class="col-12">
                                <div class="info-card card border-0 shadow-sm">
                                  <div class="card-header bg-transparent border-0 pb-2">
                                    <h6 class="mb-0 text-indigo font-weight-bold">
                                      <i class="fas fa-calendar-alt mr-2"></i>Schedule & Assignment
                                    </h6>
                                  </div>
                                  <div class="card-body">
                                    <div class="row g-3">
                                      <div class="col-md-4">
                                        <div
                                          class="d-flex align-items-center p-3 bg-indigo-light rounded-lg border h-100">
                                          <div
                                            class="icon-circle bg-warning text-white rounded-circle d-flex align-items-center justify-content-center mr-3 shadow"
                                            style="width: 42px; height: 42px;">
                                            <i class="fas fa-calendar-day"></i>
                                          </div>
                                          <div>
                                            <small class="text-muted d-block mb-1">Preferred Date</small>
                                            <span class="text-dark font-weight-bold d-block">
                                              <%= new Date(item.preferredDate).toLocaleDateString('en-US', {
                                                weekday: 'long' , year: 'numeric' , month: 'long' , day: 'numeric' }) %>
                                            </span>
                                            <small class="text-muted">
                                              <%= new Date(item.preferredDate).toLocaleTimeString('en-US', {
                                                hour: '2-digit' , minute: '2-digit' }) %>
                                            </small>
                                          </div>
                                        </div>
                                      </div>
                                      <div class="col-md-4">
                                        <div class="d-flex align-items-center p-3 bg-light rounded-lg border h-100">
                                          <div
                                            class="icon-circle bg-secondary text-white rounded-circle d-flex align-items-center justify-content-center mr-3 shadow"
                                            style="width: 42px; height: 42px;">
                                            <i class="fas fa-user-cog"></i>
                                          </div>
                                          <div>
                                            <small class="text-muted d-block mb-1">Assigned Technician</small>
                                            <span class="text-dark font-weight-bold">
                                              <%= assignedTechnician ? assignedTechnician.name : 'Not Assigned' %>
                                            </span>
                                            <% if (assignedTechnician && assignedTechnician.phone) { %>
                                              <small class="text-muted d-block">
                                                <%= assignedTechnician.phone %>
                                              </small>
                                              <% } %>
                                          </div>
                                        </div>
                                      </div>
                                      <div class="col-md-4">
                                        <div class="d-flex align-items-center p-3 bg-light rounded-lg border h-100">
                                          <div
                                            class="icon-circle bg-dark text-white rounded-circle d-flex align-items-center justify-content-center mr-3 shadow"
                                            style="width: 42px; height: 42px;">
                                            <i class="fas fa-user-tie"></i>
                                          </div>
                                          <div>
                                            <small class="text-muted d-block mb-1">Assigned By</small>
                                            <% const assignedByTechnician=users.find(technician=>
                                              technician.id.toString() == item.assignedBy); %>
                                              <span class="text-dark font-weight-bold">
                                                <%= assignedByTechnician ? assignedByTechnician.name : 'System' %>
                                              </span>
                                              <small class="text-muted d-block">
                                                <%= new Date(item.createdAt).toLocaleDateString() %>
                                              </small>
                                          </div>
                                        </div>
                                      </div>
                                    </div>
                                  </div>
                                </div>
                              </div>

                            </div>
                          </div>
                        </div>

                        <!-- Modern Footer with Actions -->
                       <!-- Modern Footer with Actions -->
<div class="modal-footer border-0 bg-light rounded-bottom">
  <div class="w-100 d-flex justify-content-between align-items-center">
    <div class="text-muted small">
      <i class="fas fa-clock mr-1"></i> Created: <%= new Date(item.createdAt).toLocaleDateString('en-US', { year: 'numeric' , month: 'short' , day: 'numeric' , hour: '2-digit' , minute: '2-digit' }) %>
    </div>
    <div class="d-flex gap-2">
      <button type="button" class="btn btn-outline-secondary btn-sm px-3" data-dismiss="modal">
        <i class="fas fa-times mr-2"></i>Close
      </button>
    </div>
  </div>
</div>
                      </div>
                    </div>
                  </div>
                  <% } %>
                    <% }) %>
                      <% } %>
        </div>

      </div>
  </div>

  <!-- Bootstrap JS Bundle with Popper -->
  <!-- Required for Bootstrap modals -->
  <script src="https://code.jquery.com/jquery-3.5.1.slim.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@4.6.0/dist/js/bootstrap.bundle.min.js"></script>
</body>

</html>